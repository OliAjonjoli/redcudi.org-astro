# nginx Webhook Proxy Configuration
#
# Purpose:
#   Routes incoming webhook requests from Strapi to the webhook relay service
#   running on localhost:4000
#
# Location: /var/www/vhosts/system/cms.redcudi.org/conf/webhook.conf
#
# Key Details:
#   - Uses 'location ^~ /webhook' (prefix match with precedence)
#   - The '^~' is CRITICAL: it ensures this block matches with higher priority
#     than Plesk's Docker proxy rule 'location ~ ^/.*' (regex match)
#   - Without '^~', all requests would go to Docker instead of the relay
#
# Integration:
#   This file is included in nginx.conf via:
#   include "/var/www/vhosts/system/cms.redcudi.org/conf/webhook.conf";
#   (Must come BEFORE the Docker extension block for precedence to work)

location ^~ /webhook {
    proxy_pass http://localhost:4000/webhook;
    proxy_http_version 1.1;
    
    # Forward client information
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # Buffering
    proxy_buffering off;
    proxy_request_buffering off;
}

---
import MainLayout from '../layouts/MainLayout.astro';
import { Icon } from 'astro-icon/components';
import { getStaffMembers } from '../lib/strapi';
import heroPeopleCelebration from '../assets/images/hero-people-celebration.jpg';
import sideDiverseTeam from '../assets/images/side-diverse-team.jpg';

// Fetch team members from Strapi at build time
// If the API is unreachable or returns 403 (permissions), fall back to an empty list
const staffResponse = await getStaffMembers().catch((error) => {
  console.error('Error loading staff members from Strapi:', error);
  return [];
});

// Normalize data: sort by order, map to a render-friendly shape
// Strapi v5 returns flattened attributes by default; fall back to attributes for older formats
const teamMembers = (staffResponse as any[] || [])
  .map((item: any) => {
    const attrs = (item as any).attributes ?? item; // support both shapes
    
    // Extract photo URL from Strapi media field
    // Strapi v5 shape: item.photo.url or item.photo.formats.medium.url
    // Strapi v4 shape: item.attributes.photo.data.attributes.url
    const photoData = attrs?.photo?.data?.attributes || attrs?.photo;
    const photoUrl = photoData?.formats?.medium?.url || photoData?.url || null;
    const STRAPI_URL = import.meta.env.STRAPI_API_URL || 'http://localhost:1337';
    const fullPhotoUrl = photoUrl ? `${STRAPI_URL}${photoUrl}` : null;
    
    // Extract social media - handle both v4 and v5 formats
    // v5: attrs.social_media is the component object directly
    // v4: attrs.social_media.data.attributes contains the component data
    let socialMedia = attrs?.social_media || {};
    if (socialMedia?.data?.attributes) {
      socialMedia = socialMedia.data.attributes; // v4 format
    }
    
    // Extract pronouns - handle both v4 and v5 formats
    // v5: attrs.pronouns is an array of component objects with direct structure
    // v4: attrs.pronouns.data is an array of component objects
    let pronounsArray = attrs?.pronouns || [];
    if (pronounsArray?.data) {
      pronounsArray = pronounsArray.data; // v4 format
    }
    
    // Get the value from pronouns
    const pronounsValue = pronounsArray?.[0]?.value || '';
    
    // Process social media links - filter out null/empty values and the 'id' field
    const activeSocialLinks = Object.entries(socialMedia || {})
      .filter(([key, value]) => {
        if (key === 'id' || !value) return false;
        if (typeof value === 'string') return value.trim() !== '';
        return true;
      })
      .map(([key, value]) => ({ platform: key, url: String(value) }));
    
    console.log(`Staff Member: ${attrs?.firstName} ${attrs?.lastName}`, {
      pronounsRaw: attrs?.pronouns,
      pronounsExtracted: pronounsValue,
      socialMediaRaw: attrs?.social_media,
      socialMediaExtracted: socialMedia,
    });
    
    return {
      id: item.id,
      firstName: attrs?.firstName || '',
      lastName: attrs?.lastName || '',
      role: attrs?.role || '',
      bio: attrs?.bio || '',
      pronouns: pronounsValue,
      socialMedia: activeSocialLinks, // Already processed and filtered!
      order: attrs?.order ?? 0,
      image: fullPhotoUrl || 'https://via.placeholder.com/300x300?text=Sin+Foto&fontSize=12&bgColor=E5D9F2&textColor=60579F',
    };
  })
  .sort((a: any, b: any) => a.order - b.order);

// Function to get pronoun color class
function getPronounColorClass(pronouns: string): string {
  if (pronouns.includes('ella') || pronouns.includes('femenino')) {
    return 'pronoun-ella';
  } else if (pronouns.includes('√©l') || pronouns.includes('masculino')) {
    return 'pronoun-el';
  } else {
    // For neutral pronouns, randomize between colors
    const neutralColors = ['pronoun-neutral-orange', 'pronoun-neutral-green', 'pronoun-neutral-yellow', 'pronoun-neutral-purple'];
    return neutralColors[Math.floor(Math.random() * neutralColors.length)];
  }
}

// Social media configuration for team members
const socialMediaConfig: Record<string, { label: string; ariaLabel: string; icon: string }> = {
  facebook: { label: 'Facebook', ariaLabel: 'Facebook de {name}', icon: 'lucide:facebook' },
  instagram: { label: 'Instagram', ariaLabel: 'Instagram de {name}', icon: 'lucide:instagram' },
  twitter: { label: 'Twitter', ariaLabel: 'Twitter de {name}', icon: 'lucide:twitter' },
  tiktok: { label: 'TikTok', ariaLabel: 'TikTok de {name}', icon: 'proicons:tiktok' },
  linkedin: { label: 'LinkedIn', ariaLabel: 'LinkedIn de {name}', icon: 'lucide:linkedin' },
  website: { label: 'Website', ariaLabel: 'Website de {name}', icon: 'lucide:globe' },
  youtube: { label: 'YouTube', ariaLabel: 'YouTube de {name}', icon: 'lucide:youtube' },
  bluesky: { label: 'Bluesky', ariaLabel: 'Bluesky de {name}', icon: 'proicons:bluesky' },
  threads: { label: 'Threads', ariaLabel: 'Threads de {name}', icon: 'mingcute:threads-line' },
  email: { label: 'Email', ariaLabel: 'Email de {name}', icon: 'lucide:mail' },
};

const coreValues = [
  {
    title: "Inclusi√≥n",
    description: "Creamos espacios seguros y acogedores para toda la comunidad LGBTQ+",
    icon: "üåà",
  },
  {
    title: "Confianza",
    description: "Conectamos con profesionales verificados y confiables de la salud",
    icon: "ü§ù",
  },
  {
    title: "Accesibilidad",
    description: "Brindamos acceso equitativo a servicios de calidad para todas las personas",
    icon: "‚ôø",
  },
  {
    title: "Empoderamiento",
    description: "Apoyamos la autonom√≠a y el bienestar de la comunidad trans y LGBTQ+",
    icon: "‚úä",
  },
];
---

<MainLayout 
  title="Nosotres"
  description="Conoce m√°s sobre redcudi.org"
  currentPage="/about/"
>

  <!-- Hero Section -->
  <section class="min-h-[60vh] flex items-center justify-center bg-cover bg-center pt-20 pb-12" style={`background-image: linear-gradient(135deg, rgba(31, 97, 141, 0.7), rgba(96, 87, 159, 0.7), rgba(34, 139, 87, 0.7)), url('${heroPeopleCelebration.src}'); background-attachment: fixed;`}>
    <div class="section-container text-center">
      <h1 class="text-5xl md:text-6xl font-display font-bold text-white mb-6">
        Nosotres
      </h1>
      <div class="h-1 bg-gradient-to-r from-transparent via-white/50 to-transparent w-24 mx-auto mb-6"></div>
      <p class="text-2xl text-neutral-100 max-w-3xl mx-auto font-light">
        Conectando a la comunidad LGBTQ+ con profesionales de confianza y servicios de calidad
      </p>
    </div>
  </section>

  <!-- Spacer -->
  <div class="h-12 md:h-16 bg-white dark:bg-neutral-900"></div>

  <!-- Who We Are Section -->
  <section class="py-20 bg-neutral-50 dark:bg-neutral-800">
    <div class="section-container">
      <h2 class="text-4xl font-display font-bold text-neutral-900 dark:text-white mb-8 text-center">
        Qui√©nes Somos
      </h2>
      <div class="space-y-6">
        <p class="text-lg text-neutral-700 dark:text-neutral-300 leading-relaxed">
          REDCUDI es una organizaci√≥n sin fines de lucro dedicada a promover la equidad en salud para la poblaci√≥n LGBTQ+ en M√©xico. Somos l√≠deres en la conexi√≥n entre individuos de la comunidad trans y personas de identidades diversas con profesionales especializados y comprometidos que respetan plenamente su identidad y orientaci√≥n sexual.
        </p>
        <p class="text-lg text-neutral-700 dark:text-neutral-300 leading-relaxed">
          Nuestra visi√≥n es crear un ecosistema de atenci√≥n integral donde cada persona de la comunidad LGBTQ+ tenga acceso equitativo a servicios de psicolog√≠a, medicina y asesoramiento jur√≠dico de alta calidad. Trabajamos con profesionales √©ticamente comprometidos que combinan expertise t√©cnico con genuina sensibilidad hacia las realidades y necesidades espec√≠ficas de nuestra comunidad.
        </p>
      </div>
    </div>
  </section>

  <!-- Mission & Vision Section -->
  <section class="py-20 bg-white dark:bg-neutral-900">
    <div class="section-container">
      <div class="grid md:grid-cols-2 gap-12 items-center">
        <!-- Left: Mission & Vision -->
        <div class="space-y-12">
          <!-- Mission -->
          <div>
            <h2 class="text-3xl font-display font-bold text-neutral-900 dark:text-white mb-4">
              Misi√≥n
            </h2>
            <p class="text-lg text-neutral-700 dark:text-neutral-300 leading-relaxed">
              Proporcionamos acceso a servicios especializados en psicolog√≠a, medicina y derecho a trav√©s de una red de profesionales comprometidos. Nuestro modelo facilita costos accesibles mediante alianzas con patrocinadores, garantizando que cada persona pueda acceder a atenci√≥n de calidad en un entorno confidencial, respetuoso y libre de discriminaci√≥n.
            </p>
          </div>

          <!-- Vision -->
          <div>
            <h2 class="text-3xl font-display font-bold text-neutral-900 dark:text-white mb-4">
              Visi√≥n
            </h2>
            <p class="text-lg text-neutral-700 dark:text-neutral-300 leading-relaxed">
              Aspiramos a consolidarnos como la plataforma de referencia para la poblaci√≥n trans en M√©xico, conectando a individuos y comunidades con profesionales especializados y recursos confiables. Trabajamos hacia una sociedad donde la diversidad de g√©nero y orientaci√≥n sexual sea completamente respetada, donde el acceso a servicios de calidad no dependa de limitaciones econ√≥micas, y donde cada persona pueda vivir con autenticidad, dignidad y sin prejuicios.
            </p>
          </div>
        </div>

        <!-- Right: Image -->
        <div class="flex items-center justify-center">
          <img src={sideDiverseTeam.src} alt="Equipo diverso de profesionales" class="w-full rounded-lg shadow-lg object-cover aspect-square" />
  </section>

  <!-- Core Values Section -->
  <section class="py-20 bg-neutral-50 dark:bg-neutral-800">
    <div class="section-container">
      <div class="text-center mb-16">
        <h2 class="text-4xl font-display font-bold text-neutral-900 dark:text-white mb-4">
          Nuestros Valores
        </h2>
        <p class="text-lg text-neutral-600 dark:text-neutral-400 max-w-2xl mx-auto">
          Los principios que gu√≠an nuestro trabajo y definen qui√©nes somos como organizaci√≥n.
        </p>
      </div>

      <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
        {coreValues.map((value) => (
          <div class="bg-white dark:bg-neutral-700 p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow border-t-4 border-brand-teal-base dark:border-brand-teal-light">
            <div class="text-4xl mb-4">{value.icon}</div>
            <h3 class="text-xl font-display font-bold text-neutral-900 dark:text-white mb-3">
              {value.title}
            </h3>
            <p class="text-neutral-600 dark:text-neutral-300">
              {value.description}
            </p>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Team Section -->
  <section class="py-20 bg-white dark:bg-neutral-900">
    <div class="section-container">
      <div class="text-center mb-16">
        <h2 class="text-4xl font-display font-bold text-neutral-900 dark:text-white mb-4">
          Nuestro Equipo
        </h2>
        <p class="text-lg text-neutral-600 dark:text-neutral-400 max-w-2xl mx-auto">
          Personas comprometidas con la inclusi√≥n y el bienestar de la comunidad LGBTQ+.
        </p>
      </div>

      <!-- Team Members Alternating Layout -->
      <div class="space-y-20">
        {teamMembers.map((member: any, index: number) => {
          const fullName = `${member.firstName} ${member.lastName}`.trim();
          const pronounColorClass = getPronounColorClass(member.pronouns);
          
          return (
            <div class={`grid md:grid-cols-2 gap-8 md:gap-12 items-center ${index % 2 === 1 ? 'md:auto-cols-max md:[direction:rtl]' : ''}`}>
              {/* Content */}
              <div class={index % 2 === 1 ? 'md:[direction:ltr]' : ''}>
                <h3 class="text-3xl md:text-4xl font-display font-bold text-neutral-900 dark:text-white mb-1">
                  {fullName || 'Nombre del Miembro'}
                </h3>
                {member.pronouns && (
                  <p class={`text-sm font-semibold px-3 py-1 rounded-full inline-block mb-3 ${pronounColorClass}`}>
                    {member.pronouns}
                  </p>
                )}
                <p class="text-lg font-semibold text-brand-teal-base dark:text-brand-teal-light mb-4">
                  {member.role || 'Posici√≥n/Rol'}
                </p>
                <p class="text-neutral-600 dark:text-neutral-400 text-lg leading-relaxed mb-6">
                  {member.bio || 'Biograf√≠a no disponible'}
                </p>
                
                {/* Social Media Links */}
                {member.socialMedia.length > 0 && (
                  <div class="flex gap-3">
                    {member.socialMedia.map(({ platform, url }: any) => {
                      const config = socialMediaConfig[platform];
                      const href = platform === 'email' ? `mailto:${url}` : url;
                      const target = platform === 'email' ? '_self' : '_blank';
                      
                      return (
                        <a
                          href={href}
                          target={target}
                          rel={platform === 'email' ? '' : 'noopener noreferrer'}
                          aria-label={config?.ariaLabel.replace('{name}', fullName) || platform}
                          class="p-2 rounded-full bg-neutral-100 dark:bg-neutral-700 text-neutral-600 dark:text-neutral-300 hover:bg-brand-teal-base dark:hover:bg-brand-teal-dark hover:text-white transition-all inline-flex items-center justify-center"
                          title={config?.label}
                        >
                          {config?.icon && <Icon name={config.icon} class="w-5 h-5" />}
                        </a>
                      );
                    })}
                  </div>
                )}
              </div>

              {/* Image / Placeholder */}
              <div class={index % 2 === 1 ? 'md:[direction:ltr]' : ''}>
                <div class="bg-gradient-to-br from-brand-purple-light to-brand-teal-light rounded-lg overflow-hidden h-72 md:h-96 flex items-center justify-center profile-image-hover">
                  {member.image && member.image.startsWith('http') ? (
                    <img 
                      src={member.image} 
                      alt={fullName || 'Miembro del equipo'}
                      class="w-full h-full object-cover"
                    />
                  ) : (
                    <div class="text-white text-4xl font-display">
                      {fullName ? fullName.split(' ').map((p) => p[0]).join('').slice(0, 2) : 'üåà'}
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  </section>

  <!-- Call to Action Section -->
  <section class="py-16 bg-gradient-to-r from-brand-green-base to-brand-teal-base">
    <div class="section-container text-center">
      <h2 class="text-3xl md:text-4xl font-display font-bold text-white mb-6">
        ¬øQuieres ser parte de redcudi?
      </h2>
      <p class="text-lg text-neutral-100 mb-8 max-w-2xl mx-auto">
        √önete a nuestra comunidad o colabora como profesional de la salud para apoyar a la comunidad LGBTQ+.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href="/directory/" class="btn-primary bg-white text-brand-teal-dark hover:bg-neutral-100">
          Ver Directorio
        </a>
        <a href="/contacto/" class="btn-secondary border-white text-white hover:bg-white hover:text-brand-teal-dark">
          Ponte en Contacto
        </a>
      </div>
    </div>
  </section>
</MainLayout>
